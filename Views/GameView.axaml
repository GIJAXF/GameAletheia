<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:GameAletheiaCross.ViewModels"
             xmlns:views="using:GameAletheiaCross.Views"
             x:Class="GameAletheiaCross.Views.GameView"
             x:DataType="vm:GameViewModel">
    
    <Design.DataContext>
        <vm:GameViewModel />
    </Design.DataContext>
    
    <Grid>
        <!-- ========================================
             CAPA 1: CANVAS DEL JUEGO (SIEMPRE VISIBLE)
             ======================================== -->
        <Canvas x:Name="GameCanvas" Width="1280" Height="720" Background="#1a1a2e" ClipToBounds="True">
            
            <!-- PLATAFORMAS -->
            <ItemsControl ItemsSource="{Binding CurrentLevel.Platforms}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Rectangle Fill="#0f3460" 
                                 Stroke="#00ff88"
                                 StrokeThickness="2"
                                 Width="{Binding Width}" 
                                 Height="{Binding Height}"
                                 Canvas.Left="{Binding X}"
                                 Canvas.Top="{Binding Y}" />
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            
            <!-- NPCs -->
            <ItemsControl ItemsSource="{Binding CurrentLevel.NPCs}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Ellipse Fill="#00d9ff" 
                               Stroke="#0080FF"
                               StrokeThickness="1"
                               Width="40" 
                               Height="40"
                               Canvas.Left="{Binding PositionX}"
                               Canvas.Top="{Binding PositionY}">
                            <Ellipse.RenderTransform>
                                <TranslateTransform X="-20" Y="-20" />
                            </Ellipse.RenderTransform>
                        </Ellipse>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            
            <!-- JUGADOR -->
            <Rectangle Fill="#e94560" 
                     Stroke="#ff0080"
                     StrokeThickness="2"
                     Width="40" 
                     Height="60"
                     Canvas.Left="{Binding Player.Position.X}"
                     Canvas.Top="{Binding Player.Position.Y}">
                <Rectangle.RenderTransform>
                    <TranslateTransform X="-20" Y="-60" />
                </Rectangle.RenderTransform>
            </Rectangle>
            
            <!-- ZONA DE SALIDA (Portal) -->
            <Ellipse Fill="#00ff88" 
                   Opacity="0.6"
                   Stroke="#00ff00"
                   StrokeThickness="2"
                   Width="60" 
                   Height="80"
                   Canvas.Left="700"
                   Canvas.Top="420">
                <Ellipse.RenderTransform>
                    <TranslateTransform X="-30" Y="-80" />
                </Ellipse.RenderTransform>
            </Ellipse>
        </Canvas>
        
        <!-- ========================================
             CAPA 2: UI OVERLAY DEL JUEGO
             ======================================== -->
        <Grid>
            <!-- Info del nivel (arriba izquierda) - SE OCULTA CUANDO HAY DIÃLOGO -->
            <StackPanel HorizontalAlignment="Left" 
                       VerticalAlignment="Top" 
                       Margin="20"
                       IsVisible="{Binding !IsDialogueActive}">
                <TextBlock Text="{Binding LevelInfo}" 
                         FontSize="18" 
                         FontWeight="Bold"
                         Foreground="#00d9ff" />
                <TextBlock Text="{Binding Player.Name}" 
                         FontSize="14" 
                         Foreground="White" 
                         Margin="0,5,0,0" />
                <TextBlock FontSize="14" 
                         Foreground="#e94560" 
                         Margin="0,5,0,0">
                    <Run Text="â¤ï¸ HP: "/><Run Text="{Binding Player.Health}"/>
                </TextBlock>
                <TextBlock FontSize="14" 
                         Foreground="#ffd700" 
                         Margin="0,5,0,0">
                    <Run Text="â­ Score: "/><Run Text="{Binding Player.TotalScore}"/>
                </TextBlock>
            </StackPanel>
            
            <!-- Mensaje de estado (centro superior) - SE OCULTA CUANDO HAY DIÃLOGO -->
            <Border Background="#000000DD" 
                   Padding="20,10" 
                   CornerRadius="5"
                   HorizontalAlignment="Center" 
                   VerticalAlignment="Top" 
                   Margin="0,20,0,0"
                   MaxWidth="600">
                <Border.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="StatusMessage" Converter="{x:Static StringConverters.IsNotNullOrEmpty}"/>
                        <Binding Path="!IsDialogueActive"/>
                    </MultiBinding>
                </Border.IsVisible>
                <TextBlock Text="{Binding StatusMessage}" 
                         FontSize="14" 
                         Foreground="#FFD700"
                         TextAlignment="Center"
                         TextWrapping="Wrap" />
            </Border>
            
            <!-- Hint de interacciÃ³n (centro inferior) - CON FONDO OPACO Y SE OCULTA CUANDO HAY DIÃLOGO -->
            <Border Background="#000000" 
                   Padding="15,10" 
                   CornerRadius="5"
                   HorizontalAlignment="Center" 
                   VerticalAlignment="Bottom" 
                   Margin="0,0,0,80">
                <Border.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="InteractionHint" Converter="{x:Static StringConverters.IsNotNullOrEmpty}"/>
                        <Binding Path="!IsDialogueActive"/>
                    </MultiBinding>
                </Border.IsVisible>
                <TextBlock Text="{Binding InteractionHint}" 
                         FontSize="16" 
                         Foreground="#00d9ff"
                         TextAlignment="Center" />
            </Border>
            
            <!-- Botones (arriba derecha) -->
            <StackPanel HorizontalAlignment="Right" 
                       VerticalAlignment="Top" 
                       Margin="20" 
                       Spacing="10">
                <Button Content="ðŸ–¥ï¸ Terminal (T)" 
                       Command="{Binding OpenTerminalCommand}"
                       Background="#0f3460"
                       Foreground="White"
                       Padding="15,8" />
                <Button Content="â¸ï¸ Pausa (ESC)" 
                       Command="{Binding PauseCommand}"
                       Background="#533483"
                       Foreground="White"
                       Padding="15,8" />
            </StackPanel>
            
            <!-- â­ CONTROLES (abajo izquierda) - CON FONDO NEGRO OPACO â­ -->
            <Border Background="#000000" Opacity="0.5"
                   Padding="15" 
                   CornerRadius="5"
                   HorizontalAlignment="Left" 
                   VerticalAlignment="Bottom" 
                   Margin="20">
                <StackPanel Spacing="5">
                    <TextBlock Text="âŒ¨ï¸ Controles:" 
                             FontSize="14" 
                             FontWeight="Bold"
                             Foreground="#00d9ff" />
                    <TextBlock Text="â† â†’ : Mover" 
                             FontSize="12" 
                             Foreground="White" />
                    <TextBlock Text="â†‘ : Saltar" 
                             FontSize="12" 
                             Foreground="White" />
                    <TextBlock Text="E : Interactuar" 
                             FontSize="12" 
                             Foreground="White" />
                    <TextBlock Text="T : Terminal" 
                             FontSize="12" 
                             Foreground="White" />
                    <TextBlock Text="ESC : Pausa" 
                             FontSize="12" 
                             Foreground="White" />
                </StackPanel>
            </Border>
        </Grid>
        
        <!-- ========================================
             CAPA 3: DIÃLOGO COMO OVERLAY (OPCIONAL)
             ======================================== -->
        <ContentControl Content="{Binding ActiveDialogue}"
                       IsVisible="{Binding IsDialogueActive}">
            <ContentControl.ContentTemplate>
                <DataTemplate>
                    <views:DialogueView />
                </DataTemplate>
            </ContentControl.ContentTemplate>
        </ContentControl>
    </Grid>
</UserControl>